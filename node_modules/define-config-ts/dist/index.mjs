import fs, { constants } from 'node:fs/promises';
import { resolve } from 'node:path';
import process from 'node:process';
import { createJiti } from 'jiti';

function defineDefineConfig() {
  return (config) => {
    return config;
  };
}

const jiti = createJiti(import.meta.url, {
  // for hmr
  moduleCache: false
});
async function loadConfig(options) {
  const { cwd = process.cwd(), configFile = "", throwOnNotFound = true } = options;
  const filePath = resolve(cwd, configFile || `${options.name}.config.ts`);
  let data = {};
  const isExists = await fs.access(filePath, constants.F_OK).then(() => true).catch(() => false);
  if (!isExists) {
    if (throwOnNotFound) {
      throw new Error(`Config file not found: ${filePath}`);
    } else {
      return {
        config: {},
        configFile: ""
      };
    }
  }
  try {
    data = await jiti.import(filePath, { default: true });
  } catch (e) {
    console.error(e);
    console.error(`Failed to load config file: ${filePath}`);
  }
  return {
    config: data,
    configFile: filePath
  };
}

export { defineDefineConfig, loadConfig };
